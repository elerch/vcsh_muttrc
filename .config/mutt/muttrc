# About Me
set realname = 'Emil Lerch'
set from = 'lobo@lerch.org'
set use_from = yes
set envelope_from = yes
set timeout = 300
timeout-hook 'exec sync-mailbox'

# We won't use imap here - Maildir instead
# My mailboxes
# set folder = 'imaps://imap.gmail.com:993'
set mbox_type=Maildir
set folder = "~/Mail/gmail"
set spoolfile = '+Inbox'
set postponed = '+[Gmail]/Drafts'
set record = '+[Gmail]/Sent Mail'
unset record # Gmail automatically saves sent e-mail to +[Gmail]/Sent, so we do not want duplicates
set trash = '+[Gmail]/Trash'
set ssl_force_tls = yes
set sendmail = "sendemail"
unset record

# Move these folders outside of gmail
set record = '=Inbox/.Sent'
set trash = '=Inbox/.Trash'
set postponed = '=Inbox/.Drafts'

# Where to put the stuff
set header_cache     = ~/.mutt/cache/headers # store headers
set message_cachedir = ~/.mutt/cache/bodies  # store bodies
# set certificate_file = ~/.mutt/certificates  # store certs (touch file)


# Other
source mutt-colors-solarized-dark-256.muttrc
# source other-colors.muttrc
set read_inc=1000
set write_inc=1000
set sort=threads
set sort_aux=reverse-last-date-received
set date_format="%Y-%m-%d %H:%M"
set index_format="%2C | %Z [%D] %-30.30F (%-4.4c) %s"
set forward_format="Fwd: %s"
set mime_forward=yes
#set new_mail_command = "notify-send '%d' '%n new messages, %u unread'"
set new_mail_command = "gdbus call --session --dest=org.freedesktop.Notifications --object-path=/org/freedesktop/Notifications --method=org.freedesktop.Notifications.Notify '' 0 '' 'New Mail Received' 'Total new messages: %n' '[]' '{\"urgency\": <1>}' 5000 > /dev/null"
set signature=""
auto_view text/html

unset imap_passive # is this necessary?

# Use mousewheel
bind pager <down> next-line
bind pager <up> previous-line
# TODO
# https://wiki.archlinux.org/title/Mutt
# Set up khard
# Look at mailcap: https://gist.github.com/Konfekt/9797372146e65a70a44c1e24a35ae0a2
#                  https://jasonwryan.com/blog/2012/05/12/mutt/
# Review this stuff:
#   https://hobo.house/2016/08/08/switching-from-mutt-to-neomutt/
#   https://hobo.house/2015/09/09/take-control-of-your-email-with-mutt-offlineimap-notmuch/
#macro index,pager \cb "<enter-command> set my_pdsave=\$pipe_decode<enter>\
#        <enter-command> unset pipe_decode<enter>\
#        <pipe-entry>extract_url<enter>\
#        <enter-command> set pipe_decode=\$my_pdsave<enter>" "get URLs"

macro index,pager \cb "<enter-command>unset pipe_decode<enter><pipe-message>extract_url<enter><enter-command>set pipe_decode = no<enter>" "view URLs"

#set query_command = "khard email --parsable --search-in-source-files '%s'"
set query_command = "echo %s | xargs khard email --parsable --search-in-source-files --"
bind editor <Tab> complete-query
bind editor ^T    complete

# We can use , as a leader for commands
unbind index ,
bind index , noop

macro index ,t '<enter-command>set sort=threads<enter>' "Sort by threads"
macro index ,d '<enter-command>set sort=reverse-date-received<enter>' "Sort by reverse date"


macro index \Cf "<enter-command>unset wait_key<enter><shell-escape>printf 'Enter a search term to find with notmuch: '; read x; echo \$x >~/.cache/mutt_terms<enter><limit>~i \"\`notmuch-remote search --output=messages \$(cat ~/.cache/mutt_terms) | head -n 600 | perl -le '@a=<>;s/\^id:// for@a;$,=\"|\";print@a' | perl -le '@a=<>; chomp@a; s/\\+/\\\\+/ for@a;print@a' \`\"<enter>" "show only messages matching a notmuch pattern"
macro index A "<limit>all\n" "show all messages (undo limit)"
macro attach 'V' "<pipe-entry>iconv -c --to-code=UTF8 > ~/.cache/mutt-mail.html<enter><shell-escape>open ~/.cache/mutt-mail.html<enter>"
## This configuration relies on NerdFonts being installed and in use
## We cannot tell if NerdFonts are in use, but we can at least tell if they're
## installed
`if fc-list | grep -q Nerd; then echo set my_has_nerd=1; else echo set my_no_nerd=1; fi`
ifndef my_has_nerd finish # end here if we don't have nerd fonts installed
# Default is:
# "-%r-NeoMutt: %D [Msgs:%?M?%M/?%m%?n? New:%n?%?o? Old:%o?%?d? Del:%d?%?F? Flag:%F?%?t? Tag:%t?%?p? Post:%p?%?b? Inc:%b?%?l? %l?]---(%?T?%T/?%s/%S)-%>-(%P)---"
set status_format = "%râ€Šî‚¶ğŸ“«%Dî‚´ %?u?î‚¶ï€œ %uî‚´ ?%?R?î‚¶ó°‡¯ %Rî‚´ ?%?d?î‚¶ï‡¸ %dî‚´ ?%?t?î‚¶ï€¬ %tî‚´ ?%?F?î‚¶ï€… %Fî‚´ ?%?p?î‚¶ï€ %pî‚´? \n  \n"

# This is the default. Pager format is what you see when looking at the mail message
# set pager_format = "-%Z- %C/%m: %-20.20n   %s%*  -- (%P)"
set pager_format = "î‚¶â¯%Z  î‚´ î‚¶%C/%mî‚´ î‚¶ğŸ‘¤ %-20.20nî‚´  î‚¶ğŸ“ %sâ€‹î‚´%* î‚¶%Pî‚´"

# not addressed to me, to me, group, cc, sent by me, mailing list
set to_chars="ïˆµïŠ½ïƒ€ïˆŠï‡˜ïƒ‰ "

# unchanged mailbox, changed, read only, attach mode
set status_chars = " ï‘ªó°ó°¦"
ifdef crypt_chars set crypt_chars = "ï½ïˆ›ï±ï‚£ "
set flag_chars = "ï€«ï€…ï€”ï„§ï‘ƒ ó°”    "

# Statusbar Colors   ----------------------------------------------------------------
color status color141 default
color status color11 color241 '---Attachment: .*'             # Attachment screens
color status color11 color241 '([=a-zA-Z0-9\.,]+|\[|\])(\s)'  # bubble content 1
color status color7 color241 '(\s)([=a-zA-Z0-9\.,]+|\[|\])'  # bubble content 2
color status color7 color8 '(\% )'                       # % symbol
# This breaks stuff and I'm not sure why it's here
# color status color7 color8 '(\S)'                        # empty spaces
color status color241 default '(î‚¶|î‚´)'                      # statusline "bubbles"
# Mailbox description. Note I needed to add mailbox icon as an anchor as there
# are many, many possible characters
color status color7 color241 'ğŸ“«=?[a-zA-Z0-9\/\. ]+'  # Mailbox description (this is probably wrong)

color status white color69 '([a-zA-Z0-9\.]+)(â€Š)'           # account text (not applicable)
color status green color241 'ï€œ'                            # Unread messages count
color status blue color241 'ó°‡¯'                             # Read messages count icon
color status yellow color241 'ï€…'                           # Flagged icon
color status red color241 'ï‡¸'                              # Pending delete icon
color status black color241 'ï€'                            # Draft icon

# Pager formatting
color status magenta color241 'â¯...  '                     # Status icons (left side)
color status color11   color241 '[0-9]+/[0-9]+'              # Location of message in index
color status color76 color241 'ğŸ‘¤ .{20}'                    # Author, which is exactly 20 characters
# color status color21 color241 'ğŸ“ .+â€‹'                 # Subject
color status color81 color241 'ğŸ“ .+â€‹'                 # Subject
color status yellow color241 '[0-9]+%'                    # Place in message (right side)
